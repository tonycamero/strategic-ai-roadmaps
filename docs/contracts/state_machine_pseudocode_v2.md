# STATE MACHINE CONTRACT (SAR v2)

## STATUS
**DRAFT** (Generated by META-TICKET v2)

## 1. CANONICAL ENUMS

All state logic must use these exact enums. Do not invent new states.

### TenantLifecycleState (Derived)
| State | Condition |
| :--- | :--- |
| `ONBOARDING` | Tenant not fully onboarded |
| `INTAKE_OPEN` | Intake window open (gathering inputs) |
| `INTAKE_UNDER_REVIEW` | Window closed, Waiting for Exec Brief review |
| `BRIEF_IN_CONSULTATION` | Brief generated, waiting for "Reviewed" signal or Intake Lock |
| `INTAKE_LOCKED` | Intakes locked. Diagnostics generation phase. |
| `DIAGNOSTICS_PUBLISHED` | Diagnostics locked & published to tenant. |
| `DISCOVERY_NOTES_INGESTED` | Discovery notes added (post-call). Ready for SOP gen. |
| `SOP_TICKETS_PENDING` | SOP Tickets generated, waiting for moderation. |
| `SOP_TICKETS_APPROVED` | All tickets approved. Roadmap assembly unlocked. |
| `ROADMAP_READY` | Roadmap assembled/generated. |
| `ROADMAP_DELIVERED` | Roadmap delivered to tenant. |

### Artifact Statuses
```typescript
enum ExecutiveBriefStatus {
  DRAFT = 'draft',
  GENERATED = 'generated',
  REVIEWED = 'reviewed' // Consultation complete
}

enum DiagnosticStatus {
  NOT_GENERATED = 'not_generated',
  GENERATED = 'generated',
  LOCKED = 'locked',
  PUBLISHED = 'published'
}

enum DiscoveryNotesStatus {
  DRAFT = 'draft',
  INGESTED = 'ingested'
}

enum SopTicketStatus {
  GENERATED = 'generated',
  PENDING = 'pending',
  APPROVED = 'approved',
  REJECTED = 'rejected',
  LOCKED = 'locked'
}
```

## 2. SOURCE OF TRUTH (DERIVATION LOGIC)

Use this function to determine the current `TenantLifecycleState`. Do not store derived state.

```typescript
function deriveTenantLifecycle(t: Tenant): TenantLifecycleState {
  // 1. Onboarding
  if (!t.onboarded) return 'ONBOARDING';

  // 2. Intake Gathering
  if (!t.intakeWindowClosed) return 'INTAKE_OPEN';

  // 3. Exec Brief Generation
  if (!t.executiveBriefExists) return 'INTAKE_UNDER_REVIEW';

  // 4. Consultation / Perfection Loop
  // Must have brief reviewed AND explicit intake lock to proceed
  const briefPending = ['draft', 'generated'].includes(t.executiveBriefStatus);
  if (briefPending && !t.executiveBriefReviewed) {
    return 'BRIEF_IN_CONSULTATION';
  }
  if (!t.intakeLockedAt) {
    return 'BRIEF_IN_CONSULTATION'; 
  }

  // 5. Diagnostics Phase
  if (t.diagnosticStatus !== 'published') {
    return 'INTAKE_LOCKED';
  }

  // 6. Discovery Call Phase
  if (!t.discoveryNotesIngested) {
    return 'DIAGNOSTICS_PUBLISHED';
  }

  // 7. SOP Generation Phase
  if (!t.sopTicketsGenerated) {
    return 'DISCOVERY_NOTES_INGESTED';
  }

  // 8. Ticket Moderation Phase
  // Converting 'pending' or 'rejected' implies we are still here
  const hasPendingOrRejected = t.sopTickets.some(tik => 
    ['pending', 'rejected', 'generated'].includes(tik.status)
  );
  if (hasPendingOrRejected) {
    return 'SOP_TICKETS_PENDING';
  }

  // 9. Roadmap Assembly Phase
  // All tickets must be approved to reach here
  if (!t.roadmapGenerated) {
    return 'SOP_TICKETS_APPROVED'; // Ready for assembly
  }
    
  // 10. Delivery
  if (t.roadmapGenerated && !t.roadmapDelivered) {
    return 'ROADMAP_READY';
  }

  return 'ROADMAP_DELIVERED';
}
```

## 3. GATE CONDITIONS (AUTHORITY)

These hard checks must pass before any mutation.

| Action | Required Role | Pre-Conditions |
| :--- | :--- | :--- |
| `Lock Intake` | EXEC/SA | `intakeWindowClosed`, `ExecutiveBriefReviewed` |
| `Generate Diagnostics` | EXEC/SA | `intakeLockedAt != null` |
| `Lock Diagnostics` | EXEC/SA | `diagnosticStatus == 'generated'` |
| `Publish Diagnostics` | EXEC/SA | `diagnosticStatus == 'locked'` |
| `Ingest Discovery Notes`| EXEC/SA | `diagnosticStatus == 'published'` |
| `Generate SOP Tickets` | EXEC/SA | `diagnosticStatus == 'published'`, `discoveryNotes == 'ingested'` |
| `Assemble Roadmap` | EXEC/SA | `sopTicketsGenerated`, `allTickets == 'approved'` |

## 4. INVARIANTS

1. **Intake Lock is Irreversible**: Once `intakeLockedAt` is set, it cannot be unset.
2. **Diagnostics Publish is Immutable**: Published diagnostics create a snapshot version. Future generations create new versions but do not overwrite the published one without explicit re-publish.
3. **Discovery Notes are Additive**: Ingesting notes NEVER invalidates previous diagnostics or briefs.
4. **Tenant Visibility**: Tenants ONLY see:
   - Published Diagnostics
   - Delivered Roadmaps
   - (Never Drafts, Never Exec Briefs)
