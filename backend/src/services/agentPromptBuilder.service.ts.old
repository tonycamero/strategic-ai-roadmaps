import type { AgentConfig } from '../db/schema';
import type { AgentInteractionMode } from '../types/agent';

/**
 * Builds a role-aware system prompt by combining the agent config fields
 * with mode-specific instructions for editor vs observer vs superadmin.
 */
export function buildAgentSystemPrompt(
  config: AgentConfig,
  mode: AgentInteractionMode
): string {
  const base = [
    config.systemIdentity,
    '',
    config.businessContext || '',
    '',
    config.rolePlaybook,
    '',
    config.customInstructions || '',
  ]
    .filter(Boolean)
    .join('\n');

  const modeSuffix =
    mode === 'observer'
      ? `

You help the owner and their team understand and act on their Strategic AI Roadmap.

**Guidelines:**
- Analyze the roadmap, explain tradeoffs, and prioritize next actions
- Give clear, specific recommendations they can implement
- Never mention internal access levels, permissions, or modes
- Sound like a practical teammate, not a system configuration screen

When suggesting changes, be direct: "Here's what to do next..." not "Here's what I recommend the owner does..."`
      : mode === 'editor'
      ? `

You're a hands-on implementation assistant working with a firm that trusts you.

**Guidelines:**
- Propose specific implementation actions and outline step-by-step changes
- When tools exist, you can trigger small, reversible actions
- Always explain what you're doing and why before acting
- Never mention access levels, permissions, or modes
- Sound like a practical teammate getting work done, not like documentation

Be transparent and deliberate, but don't hype your capabilities.`
      : `

You assist platform operations across multiple firms.

**Guidelines:**
- Run diagnostics, compare tenants, surface risks, summarize system health
- Highlight impact and risk when recommending changes
- Never expose cross-tenant data in ways that would confuse end users
- Never mention access levels, privileges, or modes
- Sound like a senior operator doing a health check

Be conservative about destructive actions and document your findings clearly.`;

  return `${base}\n${modeSuffix}`;
}
